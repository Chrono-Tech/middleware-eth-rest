
module.exports.id = 'e415e43d.f10178';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow e415e43d.f10178 update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"e415e43d.f10178","type":"flows"}, {
    $set: {"path":"e415e43d.f10178","body":[{"id":"6b2f3912.a09f08","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":1550,"y":420,"wires":[]},{"id":"12413869.ddc528","type":"http in","z":"e415e43d.f10178","name":"tx","url":"/tx/:hash","method":"get","upload":false,"swaggerDoc":"","x":288.75,"y":395.5,"wires":[["b7cddb28.6e1828"]]},{"id":"b7cddb28.6e1828","type":"function","z":"e415e43d.f10178","name":"transform params","func":"const prefix = global.get('settings.mongo.collectionPrefix');\n\nmsg.payload ={ \n    model: `${prefix}TX`, \n    request: {\n      _id: msg.req.params.hash\n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":478.750007629395,"y":395.50000381469704,"wires":[["755ca9a1.cdbfc8"]]},{"id":"b68ffffb.8e49e","type":"catch","z":"e415e43d.f10178","name":"","scope":null,"x":307,"y":585,"wires":[["49075d44.432d44"]]},{"id":"5c2fd91f.e496a8","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":764,"y":586,"wires":[]},{"id":"49075d44.432d44","type":"function","z":"e415e43d.f10178","name":"transform","func":"\nlet factories = global.get(\"factories\"); \n\nmsg.payload = factories.messages.generic.fail;\n    \nreturn msg;","outputs":1,"noerr":0,"x":548,"y":585,"wires":[["5c2fd91f.e496a8"]]},{"id":"cb93a20a.bb5d3","type":"http in","z":"e415e43d.f10178","name":"history","url":"/tx/:addr/history","method":"get","upload":false,"swaggerDoc":"","x":170,"y":240,"wires":[["e558bff.7e2784"]]},{"id":"e558bff.7e2784","type":"function","z":"e415e43d.f10178","name":"admin","func":"const prefix = global.get('settings.mongo.collectionPrefix');\nconst _ = global.get('_');\n\nmsg.address = msg.req.params.addr.toLowerCase();\n\n\nmsg.payload ={ \n    model: `${prefix}TX`, \n    request: {\n      $or: [\n        {'to': msg.address},\n        {'from': msg.address}\n      ]\n  },\n  options: {\n      sort: {timestamp: -1},\n      limit: parseInt(msg.req.query.limit) || 100,\n      skip: parseInt(msg.req.query.skip) || 0\n  }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":228.00000762939453,"wires":[["45ab2beb.917bc4"]]},{"id":"45ab2beb.917bc4","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":479,"y":235,"wires":[["4442f4c7.f8858c"]]},{"id":"ab0df8ed.00d388","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":1450,"y":260,"wires":[]},{"id":"755ca9a1.cdbfc8","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":675,"y":395,"wires":[["4aca6e2c.b2c23"]]},{"id":"a3dba2cb.a99a5","type":"function","z":"e415e43d.f10178","name":"transform output","func":"const _ = global.get('_');\n\nmsg.payload = _.merge({}, msg.tx, {logs: msg.payload});\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1373.5,"y":419.5,"wires":[["6b2f3912.a09f08"]]},{"id":"4442f4c7.f8858c","type":"function","z":"e415e43d.f10178","name":"transform output","func":"const prefix = global.get('settings.mongo.collectionPrefix');\n\nif(!msg.payload.length){\n    msg.payload = [];\n    return msg;\n}\n\n\n\nmsg.txs = msg.payload.map(tx=>{\n   tx.hash = tx._id;\n   delete tx._id;\n   return tx;\n});\n\n\nmsg.payload ={ \n    model: `${prefix}TxLog`, \n    request: {\n      $or:  msg.txs.map(tx=>({\n           blockNumber: tx.blockNumber,\n           txIndex: tx.index\n        }))\n  }\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":776.0694732666016,"y":236.24308013916016,"wires":[["bb8c6003.aca4a"]]},{"id":"eedad1c2.5e51b","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":1110,"y":260,"wires":[["342715a2.f4757a"]]},{"id":"342715a2.f4757a","type":"function","z":"e415e43d.f10178","name":"transform output","func":"const _ = global.get('_');\n\n\nmsg.payload = msg.txs.map(tx=>{\n    tx.logs = _.chain(msg.payload)\n        .filter(log=> log.blockNumber === tx.blockNumber && log.txIndex === tx.index)\n        .orderBy('index')\n        .map(log=> _.omit(log, ['_id', 'blockNumber', 'txIndex']))\n        .value();\n    \n    return tx;\n});\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":260,"wires":[["ab0df8ed.00d388"]]},{"id":"4aca6e2c.b2c23","type":"function","z":"e415e43d.f10178","name":"transform output","func":"const prefix = global.get('settings.mongo.collectionPrefix');\n\nmsg.tx = msg.payload[0];\n\nif(!msg.tx){\n    msg.payload = null;\n    return msg;\n}\n\n\nmsg.tx.hash = msg.tx._id;\ndelete msg.tx._id;\n\n\nmsg.payload ={ \n    model: `${prefix}TxLog`, \n    request: {\n        blockNumber: msg.tx.blockNumber,\n        txIndex: msg.tx.index\n  }\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":400,"wires":[["40aa5329.e261dc"]]},{"id":"9b10a99d.6dcee8","type":"mongo","z":"e415e43d.f10178","model":"","request":"{}","options":"{}","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.data","x":1210,"y":420,"wires":[["a3dba2cb.a99a5"]]},{"id":"40aa5329.e261dc","type":"switch","z":"e415e43d.f10178","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":1030,"y":400,"wires":[["a94fcba2.7147e8"],["9b10a99d.6dcee8"]]},{"id":"653bdef2.14537","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":1402.0000534057617,"y":346.0000162124634,"wires":[]},{"id":"bb8c6003.aca4a","type":"switch","z":"e415e43d.f10178","name":"switch","property":"payload.request","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":950,"y":240,"wires":[["8c25e889.984ae8"],["eedad1c2.5e51b"]]},{"id":"b374ecf3.24087","type":"http response","z":"e415e43d.f10178","name":"","statusCode":"","x":1323.0000457763672,"y":190.0000057220459,"wires":[]},{"id":"8c25e889.984ae8","type":"function","z":"e415e43d.f10178","name":"transform output","func":"\nlet factories = global.get(\"factories\"); \n\n    \nmsg.payload = factories.messages.generic.fail;\nreturn msg;","outputs":1,"noerr":0,"x":1136.461799621582,"y":194.01040267944336,"wires":[["b374ecf3.24087"]]},{"id":"a94fcba2.7147e8","type":"function","z":"e415e43d.f10178","name":"transform output","func":"\nlet factories = global.get(\"factories\"); \n\n    \nmsg.payload = factories.messages.generic.fail;\nreturn msg;","outputs":1,"noerr":0,"x":1205.4617919921875,"y":357.0104064941406,"wires":[["653bdef2.14537"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"e415e43d.f10178","type":"flows"}, done);
};
