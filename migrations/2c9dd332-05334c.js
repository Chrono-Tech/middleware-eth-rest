
module.exports.id = '2c9dd332.05334c';

const _ = require('lodash'),
  config = require('../config');

/**
 * @description flow 2c9dd332.05334c update
 * @param done
 */
   

module.exports.up = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.update({"path":"2c9dd332.05334c","type":"flows"}, {
    $set: {"path":"2c9dd332.05334c","body":[{"id":"27b27b8e.9827a4","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo create addr","mode":"1","requestType":"1","dbAlias":"primary.accounts","x":810,"y":180,"wires":[["10b75c3d.f32764"]]},{"id":"7c68e0a0.c140d","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"2","dbAlias":"primary.accounts","x":770,"y":540,"wires":[["e7d143e1.bb6ec"]]},{"id":"316484c0.63001c","type":"function","z":"2c9dd332.05334c","name":"transform params","func":"const prefix = global.get('settings.mongo.accountPrefix');\n\nmsg.address = msg.payload.address.toLowerCase();\n\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: [{\n       address: msg.address\n   }, {isActive: false}]\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":540,"wires":[["7c68e0a0.c140d"]]},{"id":"468de3dc.eb162c","type":"http in","z":"2c9dd332.05334c","name":"balance","url":"/addr/:addr/balance","method":"get","upload":false,"swaggerDoc":"","x":70,"y":820,"wires":[["b9926376.55375"]]},{"id":"6731d0f7.68fb4","type":"function","z":"2c9dd332.05334c","name":"transform params","func":"const prefix = global.get('settings.mongo.accountPrefix');\n\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: {\n       address: msg.req.params.addr\n   }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":820,"wires":[["a66b89d5.08b868"]]},{"id":"a66b89d5.08b868","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"0","dbAlias":"primary.accounts","x":590,"y":820,"wires":[["36a27ede.06cd52"]]},{"id":"36a27ede.06cd52","type":"function","z":"2c9dd332.05334c","name":"transform output","func":"\nconst _ = global.get('_');\n\nmsg.payload = {\n  balance: _.get(msg.payload, '0.balance', 0),\n  erc20token: _.get(msg.payload, '0.erc20token', {})\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":820,"wires":[["6e227f25.b210e"]]},{"id":"6e227f25.b210e","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","x":911.250007629395,"y":819.99999904632,"wires":[]},{"id":"e859d127.685df","type":"catch","z":"2c9dd332.05334c","name":"","scope":["40f17cdb.c48454","20e2bac.5686746","468de3dc.eb162c","623d7287.8bfe9c","edc524a.f0b1ed8","f54081cc.6350a","49a98529.03d56c","63ec21e7.0aa9b","2dde0078.98ad5","9cbed3f4.973d1","e69e2f39.1956d","10b75c3d.f32764","7fc66c74.40f0c4","9966b6dc.782878","e63736fc.ecaf58","e7d143e1.bb6ec","2e2f80ee.29994","d51e856c.94bf48","6e227f25.b210e","3089efd5.1a8e5","b9926376.55375","7c5c8435.9e0b9c","2528e354.e9b64c","7c68e0a0.c140d","a66b89d5.08b868","8eb922da.30d21","82a83666.a276e8","71f5d41.f7d1d2c","66d9378b.b5ca68","692906ce.c34228","46a7901e.31b49","d47923c.db3aae","36a27ede.06cd52","6731d0f7.68fb4","316484c0.63001c"],"x":100,"y":920,"wires":[["d47923c.db3aae","82a83666.a276e8"]]},{"id":"2e2f80ee.29994","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","x":730,"y":900,"wires":[]},{"id":"d47923c.db3aae","type":"function","z":"2c9dd332.05334c","name":"transform","func":"\nlet factories = global.get(\"factories\"); \nlet error = msg.error.message;\ntry {\n    error = JSON.parse(error);\n}catch(e){}\n\nmsg.payload = error && error.code === 11000 ? \nfactories.messages.address.existAddress :\nfactories.messages.generic.fail;\n\nif (msg.statusCode == '401' || msg.statusCode == '400')\n   msg.payload = factories.messages.generic.failAuth;\n\n   \n   \nreturn msg;","outputs":1,"noerr":0,"x":340,"y":920,"wires":[["692906ce.c34228"]]},{"id":"edc524a.f0b1ed8","type":"catch","z":"2c9dd332.05334c","name":"","scope":["27b27b8e.9827a4"],"x":630,"y":80,"wires":[["46a7901e.31b49"]]},{"id":"46a7901e.31b49","type":"function","z":"2c9dd332.05334c","name":"transform","func":"const factories = global.get(\"factories\");\n\nlet error = msg.error.message;\ntry {\n    error = JSON.parse(error);\n}catch(e){}\n\nif(error.code !== 11000)\nthrow new Error(msg.error.message);\n\nmsg.payload = {\n    model: 'EthAccount', \n    request: [\n        {address: msg.payload.request.address}, \n        {$set: msg.payload.request.nem ? { \n            nem: msg.payload.request.nem,\n            isActive: true\n        } : {\n            isActive: true\n        }\n            \n        }\n        ]\n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":80,"wires":[["8eb922da.30d21"]]},{"id":"8eb922da.30d21","type":"mongo","z":"2c9dd332.05334c","model":"EthAccount","request":"{}","options":"","name":"mongo","mode":"1","requestType":"2","dbAlias":"primary.accounts","x":1030,"y":80,"wires":[["10b75c3d.f32764"]]},{"id":"623d7287.8bfe9c","type":"async-function","z":"2c9dd332.05334c","name":"calc balance","func":"const factories = global.get('factories');\nconst _ = global.get('_');\nconst prefix = global.get('settings.mongo.accountPrefix');\n\nlet balance = 0;\n\n\nlet erc20token = _.chain(msg.payload.erc20tokens)\n    .transform((acc, addr) => {\n      acc[addr.toLowerCase()] = 0;\n    }, {})\n    .value();\n\nmsg.address = msg.payload.address.toLowerCase();\n\nmsg.payload = {\n    model: `${prefix}Account`, \n    request: {\n       address: msg.payload.address.toLowerCase(),\n       erc20token: erc20token,\n       balance: balance,\n       isActive: true,\n       nem: msg.payload.nem\n       }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":180,"wires":[["27b27b8e.9827a4"]]},{"id":"66d9378b.b5ca68","type":"amqp in","z":"2c9dd332.05334c","name":"post addresses","topic":"${config.rabbit.serviceName}.account.create","configname":"","iotype":"3","ioname":"events","noack":"1","durablequeue":"1","durableexchange":"0","server":"","servermode":"1","x":120,"y":260,"wires":[["e63736fc.ecaf58"]]},{"id":"10b75c3d.f32764","type":"function","z":"2c9dd332.05334c","name":"","func":"\nif(msg.amqpMessage)\n    msg.amqpMessage.ackMsg();\n\nmsg.payload = JSON.stringify({address: msg.address})\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":180,"wires":[["e69e2f39.1956d","3089efd5.1a8e5"]]},{"id":"e63736fc.ecaf58","type":"function","z":"2c9dd332.05334c","name":"","func":"\nmsg.payload = JSON.parse(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":260,"wires":[["623d7287.8bfe9c"]]},{"id":"e69e2f39.1956d","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}.account.created","iotype":"3","ioname":"events","server":"","servermode":"1","x":1330,"y":120,"wires":[]},{"id":"63ec21e7.0aa9b","type":"amqp in","z":"2c9dd332.05334c","name":"delete addresses","topic":"${config.rabbit.serviceName}.account.delete","iotype":"3","ioname":"events","noack":"0","durablequeue":"1","durableexchange":"0","server":"","servermode":"1","x":120,"y":660,"wires":[["9966b6dc.782878"]]},{"id":"9966b6dc.782878","type":"function","z":"2c9dd332.05334c","name":"","func":"\nmsg.payload = JSON.parse(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":660,"wires":[["316484c0.63001c"]]},{"id":"e7d143e1.bb6ec","type":"function","z":"2c9dd332.05334c","name":"","func":"\nif(msg.amqpMessage)\n    msg.amqpMessage.ackMsg();\n\nmsg.payload = JSON.stringify({address: msg.address})\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":540,"wires":[["9cbed3f4.973d1"]]},{"id":"9cbed3f4.973d1","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}.account.deleted","iotype":"3","ioname":"events","server":"","servermode":"1","x":1210,"y":540,"wires":[]},{"id":"692906ce.c34228","type":"switch","z":"2c9dd332.05334c","name":"","property":"amqpMessage","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":510,"y":920,"wires":[["2e2f80ee.29994"],["20e2bac.5686746","71f5d41.f7d1d2c"]]},{"id":"20e2bac.5686746","type":"async-function","z":"2c9dd332.05334c","name":"","func":"if(msg.error.message.includes('CONNECTION ERROR')){\n    await Promise.delay(5000);\n    await msg.amqpMessage.nackMsg();\n}else{\n    await msg.amqpMessage.ackMsg();\n}\n    \nmsg.payload = typeof msg.error.message;    \n    \nreturn msg;","outputs":1,"noerr":6,"x":730,"y":960,"wires":[[]]},{"id":"71f5d41.f7d1d2c","type":"debug","z":"2c9dd332.05334c","name":"","active":true,"console":"false","complete":"error","x":739.0729522705078,"y":1005.895881652832,"wires":[]},{"id":"82a83666.a276e8","type":"debug","z":"2c9dd332.05334c","name":"","active":true,"console":"false","complete":"error","x":283.0833282470703,"y":1074.9063186645508,"wires":[]},{"id":"3089efd5.1a8e5","type":"amqp out","z":"2c9dd332.05334c","name":"","topic":"${config.rabbit.serviceName}_user.created","iotype":"3","ioname":"internal","server":"","servermode":"1","x":1320,"y":180,"wires":[]},{"id":"f54081cc.6350a","type":"http in","z":"2c9dd332.05334c","name":"create addr","url":"/addr","method":"post","upload":false,"swaggerDoc":"","x":110,"y":40,"wires":[["7fc66c74.40f0c4"]]},{"id":"7fc66c74.40f0c4","type":"function","z":"2c9dd332.05334c","name":"","func":"\nmsg.payload = JSON.stringify(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":40,"wires":[["d51e856c.94bf48","40f17cdb.c48454"]]},{"id":"d51e856c.94bf48","type":"http response","z":"2c9dd332.05334c","name":"","statusCode":"","headers":{},"x":410,"y":20,"wires":[]},{"id":"40f17cdb.c48454","type":"amqp out","z":"2c9dd332.05334c","name":"address_created","topic":"${config.rabbit.serviceName}.account.create","configname":"","iotype":"3","ioname":"events","server":"","servermode":"1","x":460,"y":80,"wires":[]},{"id":"49a98529.03d56c","type":"amqp in","z":"2c9dd332.05334c","name":"create_from_laborx","topic":"address.created","configname":"laborx","iotype":"1","ioname":"profiles","noack":"0","durablequeue":"1","durableexchange":"1","server":"","servermode":"1","x":130,"y":160,"wires":[["2528e354.e9b64c"]]},{"id":"2528e354.e9b64c","type":"laborx_get_addr","z":"2c9dd332.05334c","addr":"eth-address","name":"laborx_get_addr","x":320,"y":160,"wires":[["623d7287.8bfe9c"]]},{"id":"2dde0078.98ad5","type":"amqp in","z":"2c9dd332.05334c","name":"delete_from_laborx","topic":"address.deleted","configname":"laborx","iotype":"1","ioname":"profiles","noack":"0","durablequeue":"1","durableexchange":"1","server":"","servermode":"1","x":130,"y":520,"wires":[["7c5c8435.9e0b9c"]]},{"id":"7c5c8435.9e0b9c","type":"laborx_get_addr","z":"2c9dd332.05334c","addr":"eth-address","name":"laborx_get_addr","x":320,"y":520,"wires":[["316484c0.63001c"]]},{"id":"b9926376.55375","type":"laborx_auth","z":"2c9dd332.05334c","name":"laborx_auth","configprovider":"1","dbAlias":"accounts","providerpath":"http://localhost:3001","x":210,"y":820,"wires":[["6731d0f7.68fb4"]]}]}
  }, {upsert: true}, done);
};

module.exports.down = function (done) {
  let coll = this.db.collection(`${_.get(config, 'nodered.mongo.collectionPrefix', '')}noderedstorages`);
  coll.remove({"path":"2c9dd332.05334c","type":"flows"}, done);
};
